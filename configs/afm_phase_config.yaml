# AFM Phase Separation Training Configuration
# 통합된 Identity/Motion 계층 학습 시스템

# Model configuration
model:
  model_source: "LTXV_2B_0.9.6_DEV"
  training_mode: "lora"
  load_checkpoint: null  # 10k 체크포인트 경로를 여기에 설정

# LoRA configuration
lora:
  rank: 128
  alpha: 128
  dropout: 0.05
  target_modules:
    - "to_k"
    - "to_q"
    - "to_v"
    - "to_out.0"

# AFM Phase Separation Configuration
conditioning:
  mode: "ring_fm"
  first_frame_conditioning_p: 0.1
  t_star: 0.2                    # Local/Global 경계

# AFM Training Parameters
afm_training:
  use_phase_separation: true     # Phase Separation 활성화
  auto_transition_step: 10000    # Stage 1 → Stage 2 자동 전환 스텝
  
  # Stage 1: Global Identity Training (0 ~ 10k steps)
  stage1_config:
    description: "Identity Formation"
    timestep_range: [0.2, 1.0]   # Global Phase 집중
    motion_gain: 1.0              # 표준 학습
    loss_weights:
      local: 0.0                  # Local Loss 차단  
      global: 1.0                 # Global Loss 활성화

  # Stage 2: Local Motion Training (10k+ steps)  
  stage2_config:
    description: "Motion Refinement"
    timestep_range: [0.0, 0.2]   # Local Phase 100% 집중
    motion_gain: 2.0              # Motion 강화 학습
    loss_weights:
      local: 10.0                 # Local Loss 극대화
      global: 0.0                 # Global Loss 차단

# Flow Matching configuration
flow_matching:
  timestep_sampling_mode: "afm_phase"  # AFM Phase-Aware 샘플링
  timestep_sampling_params: {}

# Optimization configuration
optimization:
  learning_rate: 1e-4
  steps: 20000                   # Stage 1(10k) + Stage 2(10k)
  batch_size: 1
  gradient_accumulation_steps: 1
  max_grad_norm: 0.5
  optimizer_type: "adamw8bit"
  scheduler_type: "linear"
  scheduler_params: {}
  enable_gradient_checkpointing: true

# Acceleration configuration
acceleration:
  mixed_precision_mode: "bf16"
  quantization: null
  load_text_encoder_in_8bit: false
  compile_with_inductor: false
  compilation_mode: "reduce-overhead"

# Data configuration
data:
  preprocessed_data_root: "/home/dongwoo38/openvid_data"
  num_dataloader_workers: 2

# Validation configuration
validation:
  skip_initial_validation: false
  prompts:
    - "The video features a man in a suit and tie, sitting in an office setting. The man is speaking, and his expression is serious. The office has a window with blinds, and the lighting is soft and natural. The man's suit is dark, and his tie is patterned. The office appears to be well-lit, with a warm tone to the lighting. The man's posture is upright, and he is looking directly at the camera. The overall style of the video is professional and formal."
  
  video_dims: [512, 512, 25]
  interval: 2000                 # Stage별 검증 (2k마다)
  inference_steps: 50
  guidance_scale: 3.5

# Checkpoint configuration  
checkpoints:
  interval: 2000                 # 정기 체크포인트 (2k마다)
  keep_last_n: 5                # 최근 5개 유지

output_dir: "outputs/afm_phase_separation_v1"
seed: 42
wandb:
  enabled: true
  project: "afm-phase-separation"
  tags: ["afm", "phase-separation", "identity-motion"]